#!/usr/bin/python3
import sys
import os

import parse
import mutator
import thread_manager

from log import *
from queue import Queue

def handleCrash(crashInput: bytes) -> bool:
    if crashInput is not None:
        logger.info("Found crash")
        with open(os.path.join(ROOT_DIR, "bad.txt"), "wb") as badtxt:
            badtxt.write(crashInput)
        logger.info('Bad input written to ' + os.path.join(ROOT_DIR, 'bad.txt'))
        return True
    return False

def checkArgs():
    if len(sys.argv) != 3:
        logger.info(f"Usage: {sys.argv[0]} binaryfilename inputfilename")
        exit(0)

if __name__ == "__main__":
    checkArgs()

    binary = sys.argv[1]
    inputFileName = sys.argv[2]

    inputDict = parse.getDictFromInput(inputFileName)
    thread_manager.setBinary(binary)
    
    logger.info('Starting fuzzer...')

    crashInput = thread_manager.fuzzMyLife(inputDict)
    if handleCrash(crashInput):
        logger.info("done")
    else:
        logger.info("failed :'(")